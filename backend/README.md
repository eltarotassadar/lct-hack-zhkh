# Backend HydroPulse Insight

Сервис FastAPI формирует витрину данных по показаниям ИТП/ОДПУ, вычисляет отклонения > 10% и генерирует рекомендации для диспетчерских команд. Телеметрия берется из синтетического датасета `data/telemetry.(csv|parquet)`, поэтому прототип полностью автономен.

## Требования
- Python 3.11 или 3.12
- [Poetry](https://python-poetry.org/docs/#installation)

## Установка и запуск
```bash
cd backend
poetry install
poetry run fastapi dev main.py --host 0.0.0.0 --port 8010
```

Эндпоинты будут доступны по адресу `http://localhost:8010/api`. Документацию можно открыть на `http://localhost:8010/api/docs`.

## Что делает сервис
- `GET /api/years` — возвращает список доступных отчетных лет в подготовленном датасете.
- `GET /api/buildings?year=YYYY` — список МКД с кратким сводом рисков, рассчитанных на выбранный год.
- `GET /api/buildings/{mkdId}?year=YYYY` — детальный бандл: телеметрия ИТП↔ОДПУ, рекомендации, аномалии и погодный фон.
- `POST /api/buildings/{mkdId}/feedback` — позволяет диспетчеру отметить аномалию как подтвержденную/опровергнутую.
- `GET /api/buildings/{mkdId}/report?year=YYYY` — выгружает CSV с отклонениями за год для подготовки отчета.
- `GET /api/anomalies/export?year=YYYY&mkd_id=MKD` — формирует CSV с журналом аномалий (включая статусы и комментарии диспетчеров).

Расчеты основаны на метрике абсолютного отклонения показаний ИТП (ХВС) и ОДПУ (ГВС). Если отклонение превышает 10%, точка попадает в «зону наблюдения» или выше. Итоговый риск учитывает долю аномалий, медианное отклонение и тренды потребления.

## Структура данных

- `data/telemetry.csv` — синтетическая телеметрия с января 2023 по декабрь 2025 года для трех МКД. Колонки повторяют требования ТЗ (адреса, ФИАС, УНОМ, расход ХВС/ГВС, флаги аномалий и причины).
- `data/telemetry_sample.json` — первые 60 записей телеметрии для быстрого просмотра/отладки.
- `data/feedback.csv` — журнал диспетчерской обратной связи. Каждая строка содержит идентификатор аномалии, метаданные МКД/ОДПУ, статус, комментарий и временную метку последнего обновления.

При запуске сервис загружает `feedback.csv` и восстанавливает статусы в ответах API. Новые действия диспетчера сразу записываются в файл и переживают перезапуск процесса FastAPI.

## Адаптация под собственные данные
1. Замените файлы в каталоге `data/` на выгрузку собственной телеметрии, соблюдая формат колонок из README в корне репозитория.
2. При необходимости скорректируйте функции в `model.py` (например, шкалы рисков или правила рекомендаций).
3. Модель не зависит от CatBoost — все расчеты детерминированы и воспроизводимы даже офлайн.
