# HydroPulse Insight

HydroPulse Insight — двуэкранный портал диспетчера Mosvodokanal: классическая панель МКД с рекомендациями и вкладка Geo Intelligence с гексагонами и CatBoost-прогнозом.
Сервис развёрнут и доступен по адресу https://lcthack.vercel.app/. Если возникнут проблемы - попробуйте включить ВПН.

## Быстрый старт

### UI (Vite + React)
```bash
git clone <repo>
cd lcthack
npm install
npm run dev
```
Интерфейс доступен на `http://localhost:5173`. Для проверки прод-сборки выполните:
```bash
npm run build
npm run preview -- --host 0.0.0.0 --port 4173
```

#### Переменные окружения
- `VITE_API_BASE_URL` — адрес API (по умолчанию `http://localhost:8010/api` в dev и `https://somethingintheair.tech/api` в prod).
  Укажите, если бэкенд развёрнут на другом домене или за прокси.

### API (FastAPI)
```bash
cd backend
poetry install
poetry run fastapi dev main.py --host 0.0.0.0 --port 8010
```
Эндпоинты публикуются по адресу `http://localhost:8010/api`, документация доступна на `/api/docs`.

## Функциональность
- Панель МКД с риск-индексом, балансом подачи и долей аномалий по каждому дому.
- Графики телеметрии (ИТП ХВС ↔ ОДПУ ГВС) с отображением процента отклонения.
- Рекомендации с переключателями факторов и выгрузкой CSV.
- Реестр аномалий с отметкой статуса (подтверждено / отклонено / не рассмотрено).
- Погодный фон из Open-Meteo, объединённый с телеметрией.
- **Geo Intelligence** — гексагоны H3 с пресетами округов, ручным выделением, CatBoost-ранжированием узлов и фолбэком на синтетические ряды.
- Страница «Методология» с описанием расчётов и соответствием терминов Agrohack → Mosvodokanal.

## Встраивание гео-вкладки
- Для отдельного показа геоаналитики используйте маршрут `/geo` или импортируйте компонент `GeoPage` из `src/pages/geo.jsx`.
- Пресеты гексагонов, каталог узлов и выбранные зоны сохраняются в `localStorage` (`selectedHexagons`, `selectedMonitoringNodes`).
- Fallback для 2024–2025 годов реализован на фронтенде (`src/utils/syntheticData.js`) и бэкенде (`backend/synthetic_geo.py`), поэтому карта и прогнозы остаются стабильными без внешних API.

## Макеты данных

В `data/` лежат синтетические таблицы, соответствующие требованиям Appendix 1.

`telemetry.csv` / `telemetry.parquet`:

| Колонка | Описание |
| --- | --- |
| `date` | Дата показаний (день). |
| `mkd_id`, `mkd_address`, `fias`, `unom` | Идентификаторы и адрес МКД. |
| `mkd_lat`, `mkd_lon` | Координаты здания. |
| `itp_id`, `itp_name`, `itp_lat`, `itp_lon` | Метаданные теплового пункта. |
| `odpu_id` | Идентификатор основного узла учёта. |
| `district` | Район/округ. |
| `itp_cold_water`, `itp_hot_water` | Суточные показания ИТП (м³). |
| `odpu_hot_water`, `odpu_cold_water` | Суточные показания ОДПУ (м³). |
| `deviation_ratio` | Абсолютное отклонение ОДПУ vs ИТП (в долях). |
| `anomaly` | Булево поле: `true`, если отклонение > 10%. |
| `anomaly_reason` | Человекочитаемое пояснение. |

`telemetry_sample.json` повторяет те же поля в JSON-формате.

Погодные агрегации (`weather_features.*`) содержат `date`, `geo_key`, суточные средние/минимальные/максимальные значения температуры, осадков, влажности и сезонные метки.

## Обучение модели
`training_pipeline/data_loader.py` подготавливает фреймы для `train.ipynb` и `weather.ipynb`:
1. Загружает телеметрию и пересчитывает `deviation_ratio` / `anomaly` по факту данных.
2. Добавляет `geo_key` для объединения с погодой.
3. Возвращает объединённый датафрейм для CatBoost или других табличных моделей.

Автоматизация:
```bash
python scripts/run_training.py --config configs/train.yaml
```

## Дополнительные материалы
- [docs/domain-migration.md](./docs/domain-migration.md) — карта переименований Agrohack → Mosvodokanal.
- [backend/README.md](./backend/README.md) — описание API, маршрутов и расчётов.

## План развития
- Подключение реальных потоков телеметрии и ФИАС-справочников.
- Хранение обратной связи диспетчеров в базе данных.
- Обучение и выкладка CatBoost/LightGBM модели для прогноза отклонений.
- Подготовка презентационных материалов и UI-kit.
